# üöÄ Copilot Instructions for .dotfiles Repository

## Context & Overview

This repository contains optimized shell configuration for **Ubuntu/Debian** systems with **ZSH** and **Tmux**.

### Key Goals
- ‚ö° **Maximum Performance**: ZSH startup ~110ms (92% faster than original)
- üé® **Beautiful UI**: Git/Venv/K8s aware prompts with consistent colors
- üõ°Ô∏è **Reliability**: Graceful fallbacks for missing tools, production-ready
- üìö **Documentation**: Easy setup guides and system compatibility checks

---

## üìä Current Configuration Status

### Performance Metrics
| Aspect | Value |
|--------|-------|
| ZSH startup (no tmux) | ~110ms |
| ZSH with tmux | ~850ms |
| Improvement | 92% faster than original (1.6s) |

### System Compatibility
- ‚úÖ **Tested on**: Ubuntu/Debian with zsh 5.9, git 2.43, tmux 3.4
- ‚úÖ **Required**: zsh, git, tmux
- ‚úÖ **Optional**: nvim, kubectl, helm, docker, npm, asdf, bat
- ‚úÖ **Fallbacks**: vim/nano, xsel/xclip/wl-copy/pbcopy

---

## üèóÔ∏è Architecture & File Structure

```
~/.dotfiles/
‚îú‚îÄ‚îÄ zshrc                      # Main ZSH config (optimized, 200+ lines)
‚îú‚îÄ‚îÄ tmux.conf                  # Tmux config (optimized 3.4+, 250+ lines)
‚îú‚îÄ‚îÄ kitty.conf                 # Kitty terminal config
‚îú‚îÄ‚îÄ .dircolors                 # Color palette for ls (20+ file types)
‚îú‚îÄ‚îÄ check-system.sh            # System compatibility checker
‚îú‚îÄ‚îÄ INSTALLATION.md            # Complete setup guide
‚îú‚îÄ‚îÄ zsh.d/
‚îÇ   ‚îú‚îÄ‚îÄ config.zsh             # Variables & settings
‚îÇ   ‚îú‚îÄ‚îÄ tools.zsh              # Editor, paths, npm lazy-load
‚îÇ   ‚îú‚îÄ‚îÄ alias.zsh              # Docker aliases (functions, not if-checks)
‚îÇ   ‚îú‚îÄ‚îÄ autocomplete.zsh       # Kubectl/helm/kind lazy completions
‚îÇ   ‚îî‚îÄ‚îÄ tmux.zsh               # Tmux helpers (deprecated, in main config)
‚îî‚îÄ‚îÄ hack/                      # Scripts & tools
```

---

## üéØ Key Features Implemented

### 1. ZSH Optimization
- ‚úÖ **Lazy-loading**: Plugins (Zinit), completions, npm
- ‚úÖ **Async plugins**: turbo mode with wait delays (wait"1", wait"2", wait"3")
- ‚úÖ **Compinit caching**: Uses -C flag for speed
- ‚úÖ **Reduced history**: 5000 commands (vs 10000)
- ‚úÖ **Removed heavy plugins**: history-search-multi-word
- ‚úÖ **Smart error handling**: Checks for git/Zinit before using them

### 2. Prompt System (RPROMPT)
- **Git branch**: Cyan #87 (shows only in git repos)
- **Python venv**: Magenta #213 (shows when activated)
- **Kubernetes**: Lime green #154 (shows if kubectl context exists)
- **Fallback**: "Klaatu Barada Nitko!" in yellow #226 (when no context)
- **nvcs_info format**: Empties git branch when not in repo

### 3. Tmux Integration
- ‚úÖ **Mouse**: Fully enabled and kitty-compatible
- ‚úÖ **Copy-mode**: Vi keybindings with optimized scrolling
- ‚úÖ **Aggressive-resize**: For multi-client setups
- ‚úÖ **Extended keys**: Ctrl+Up, M-PageUp support
- ‚úÖ **Focus events**: Better tool integration

### 4. Color Support
- ‚úÖ **Dircolors**: Custom palette in ~/.dircolors
- ‚úÖ **Aliases**: ls/grep/diff with --color=auto
- ‚úÖ **File types**: Archives (red), images (magenta), code (yellow), etc.
- ‚úÖ **Man pages**: LESS_TERMCAP variables configured

### 5. Compatibility Features
- ‚úÖ **Tool detection**: All tools checked with `command -v`
- ‚úÖ **Path safety**: Only add to PATH if directory exists
- ‚úÖ **Editor fallback**: nvim ‚Üí vim ‚Üí nano
- ‚úÖ **Conditional loading**: Plugins only load if Zinit available

---

## üîç Important Implementation Details

### Prompt Generation (RPROMPT)
```zsh
# Uses _build_rprompt() function that:
# 1. Checks vcs_info_msg_0_ for git branch
# 2. Checks $VIRTUAL_ENV for python venv
# 3. Checks $ZSH_KUBECTL_PROMPT for k8s context
# 4. Returns "Klaatu Barada Nitko!" if no context
# 5. Called via RPROMPT='$(_build_rprompt)' for dynamic updates
```

### Zinit Plugin Loading
```zsh
# Only loads if:
# 1. Git is available
# 2. Zinit directory exists at ~/.local/share/zinit/zinit.git
# 3. Plugins use turbo mode with conditional wait times:
#    - wait"1": zsh-kubectl-prompt (needs early)
#    - wait"2": zsh-autosuggestions, zsh-completions
#    - wait"3": fast-syntax-highlighting
```

### Lazy-Load Functions
- **npm()**: Undefines itself after first use, then sources completion
- **editor fallback**: Checks nvim/vim/nano in order
- **completions**: kubectl/helm/kind load only on first use

---

## üêõ Known Issues & Solutions

### Issue: Git branch not showing
**Solution**: `nvcs_info` style resets branch when not in repo. Normal behavior.

### Issue: Colors not showing in ls
**Solution**: Check that ~/.dircolors exists. Set with: `dircolors -p > ~/.dircolors`

### Issue: Plugins not loading
**Solution**: Install Zinit with:
```bash
git clone https://github.com/zdharma-continuum/zinit.git ~/.local/share/zinit/zinit.git
```

### Issue: Slow startup
**Solution**: Disable tmux auto-start with `export TMUX_AUTOSTART_ENABLED=false`

---

## üìù Optimization Rules & Guidelines

When making changes, follow these principles:

### Performance
1. **Never** add startup checks without `command -v` guard
2. **Always** lazy-load completions that run external commands
3. **Prefer** conditional `[[ -d $path ]]` over command checks for paths
4. **Use** Zinit turbo mode with wait delays (wait"1", wait"2", etc.)
5. **Keep** history size ‚â§ 5000 for speed

### Compatibility
1. **Check** for tool existence before using (e.g., `command -v nvim`)
2. **Provide** fallbacks (nvim ‚Üí vim ‚Üí nano)
3. **Safe defaults** if anything fails (no stderr pollution)
4. **Support** multiple clipboard managers (xsel, xclip, wl-copy, pbcopy)
5. **Test** on Ubuntu/Debian with minimal tools first

### Code Quality
1. **Comment** complex sections (vcs_info, turbo loading, etc.)
2. **Use** consistent style (2-space indents for zsh)
3. **Avoid** nested conditionals (use early returns where possible)
4. **Keep** related configs together (don't split RPROMPT logic)
5. **Remove** commented code when merging to main

### Testing
1. **Run** `check-system.sh` to validate compatibility
2. **Test** in fresh shell: `exec zsh`
3. **Measure** startup: `time zsh -ic exit`
4. **Verify** colors in actual terminal (not piped output)
5. **Check** git branch display in and out of repos

---

## üöÄ Common Tasks

### Add a New Alias
**File**: `zsh.d/alias.zsh`
```zsh
# Use function syntax (no command checks at startup)
myalias() { some-command "$@"; }
```

### Add a New Completion
**File**: `zsh.d/autocomplete.zsh`
```zsh
# Use lazy-loading pattern
if (( $+commands[mytool] )); then
  _load_mytool_completion() {
    source <(mytool completion zsh)
    unfunction _load_mytool_completion
  }
  compdef _load_mytool_completion mytool
fi
```

### Add a New Plugin
**File**: `zshrc` (in Zinit section, inside `if command -v zinit`)
```zsh
zinit ice wait"2" lucid   # wait"2" for non-critical, wait"1" for critical
zinit light user/plugin-name
```

### Change Colors
**File**: `zshrc` (in RPROMPT section)
```zsh
# Change color codes:
# %F{87}  = Bright cyan (git)
# %F{213} = Magenta (venv)
# %F{154} = Lime green (k8s)
# See: zsh color palette (0-255)
```

### Update Dircolors
**File**: `~/.dircolors`
```bash
# Run to generate default: dircolors -p > ~/.dircolors
# Then edit specific file types with new colors
*.rs 01;33              # Rust files in bright yellow
```

---

## üîÑ Git Workflow for Changes

### Feature Branch
```bash
git checkout -b feature/your-feature-name
# Make changes
# Test with: bash check-system.sh
# Test performance: time zsh -ic exit
git commit -m "feat: description of change"
git push origin feature/your-feature-name
```

### Commit Message Format
- `perf:` - Performance improvements
- `feat:` - New features
- `fix:` - Bug fixes
- `docs:` - Documentation
- `refactor:` - Code refactoring
- `chore:` - Minor changes

### Before Merging to Main
1. Run `check-system.sh` and verify all checks pass
2. Test startup time: `time zsh -ic exit` (should be <150ms)
3. Test RPROMPT in git/non-git directories
4. Verify colors in actual terminal
5. Test tmux mouse support if changed

---

## üìö Dependencies & Versions

### Tested & Working
- zsh 5.9+ (ubuntu/debian packages)
- git 2.40+ (for clone/pull)
- tmux 3.2+ (extended keys, allow-passthrough)
- GNU coreutils (dircolors, ls)

### Optional & Auto-Detected
- nvim 0.9+ or vim 8+
- kubectl/helm for k8s
- npm via asdf or nvm
- bat for colored output
- fzf for fuzzy finding

### NOT Required
- Oh-My-Zsh (we use Zinit instead)
- powerline fonts (we use Unicode symbols)
- Docker (only if you want docker aliases)

---

## üéì Learning Resources

### ZSH Specific
- [Official ZSH Doc](https://zsh.sourceforge.io/Doc/)
- [ZSH Parameter Expansion](https://zsh.sourceforge.io/Doc/Release/Expansion.html)
- [ZSH Builtins](https://zsh.sourceforge.io/Doc/Release/Shell-Builtin-Commands.html)

### Tmux
- [Tmux Man Pages](https://man.openbsd.org/tmux)
- [Tmux Config Guide](https://www.hamvocke.com/blog/a-guide-to-customizing-your-tmux-config/)

### Optimization
- [Zinit Quick Start](https://github.com/zdharma-continuum/zinit)
- [Plugin Performance](https://github.com/zdharma-continuum/zinit#plugin-performance)

---

## üìû Contact & Questions

If you need to debug or optimize further:
1. Check `check-system.sh` output for environment info
2. Run `time zsh -ic exit` to measure startup
3. Check git branch display: `cd` in/out of repo
4. Test colors: `ls -la` in real terminal (not piped)
5. Verify tmux: `tmux source ~/.tmux.conf`

---

## üìã Checklist for Future Improvements

- [ ] Add FZF keybindings if fzf becomes critical
- [ ] Consider adding zsh-vi-mode for full vi support
- [ ] Explore direnv for automatic environment loading
- [ ] Add async git status for faster prompt
- [ ] Profile startup with `zsh -X` if needed

---

**Last Updated**: December 10, 2025  
**Version**: 1.0 (Optimized & Production-Ready)  
**Maintainer**: cosckoya  
**Status**: ‚úÖ Fully tested on Ubuntu/Debian
